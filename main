import discord, os
from dotenv import load_dotenv
from discord.ext import commands
from openai import OpenAI
from database import create_tables, save_message, get_user_history
#Esto son las importanciones para las conseguir los recursos

load_dotenv()
token_d = os.getenv("d_t")
token_o = os.getenv("op_at")
#Estos son los tokens, medida de seguridad al usar git para exportar hacia github y privatizar

client_ai = OpenAI(api_key=token_o)

intents = discord.Intents.default()
intents.message_content = True
intents.guilds = True
bot = commands.Bot(command_prefix="$", intents=intents) 
#Con esto se hace un prefijo de los comandos e intentos para acceder a recursos
create_tables()

#Esto permitira saber cuando se conecta y que comandos hara para que el usuario lo use para consumo propio
@bot.event
async def on_ready():
    print(f"Bot conectado como ---> {bot.user}")

    for guild in bot.guilds:
        channel = discord.utils.get(guild.text_channels, name="general")
        if not channel:
            channel = guild.text_channels[0] if guild.text_channels else None

        if channel:
            await channel.send("¬°Hola! Para interactuar con la IA, escriba $chat seguido de su pregunta o puedes usar $image para escanear algun imagen.")

#Este comando sirve para hablar con la IA para sacar alguna informacion
@bot.command(name="chat")
async def chat(ctx, *, prompt: str):
    print(f"Comando recibido: {prompt}")
    try:
        await ctx.channel.typing()

        history = []
        async for msg in ctx.channel.history(limit=10, oldest_first=False):
            if msg.author == bot.user:
                role = "assistant"
            elif msg.content.startswith("$chat"):
                role = "user"
                msg.content = msg.content.replace("$chat", "").strip()
            else:
                continue 
            history.append({"role": role, "content": msg.content})

        history = list(reversed(history))

        history.append({"role": "user", "content": prompt})

        response = client_ai.chat.completions.create(
            model="gpt-4o-mini", #El modelo del GPT
            messages=[
                {"role": "system", "content": "Eres un asistente conversacional para Discord."},
                *history
            ],
            temperature=0.7
        )

        reply = response.choices[0].message.content
        await ctx.reply(reply)
        save_message(ctx.author.id, str(ctx.author),prompt, reply)

    except Exception as e:
        print("Error con OpenAI:", e)

        await ctx.reply("‚ùåHubo un error al contactar con la IA.‚ùå")
#En caso de que ocurra un error se notifica al chat

#Un comando para que analize y describa la IA
@bot.command(name="image")
async def image(ctx, *, prompt: str = "Describe esta imagen."):
    try:
        if not ctx.message.attachments:
            await ctx.reply("Por favor, adjunta una imagen para analizar.")
            return

        imagen_url = ctx.message.attachments[0].url
        await ctx.channel.typing()

        response = client_ai.chat.completions.create(
            model="gpt-4o-mini",  #El modelo del GPT
            messages=[
                {"role": "system", "content": "Eres un asistente que analiza im√°genes y describe lo que ve."},
                {
                    "role": "user",
                    "content": [
                        {"type": "text", "text": prompt},
                        {"type": "image_url", "image_url": {"url": imagen_url}}
                    ]
                }
            ]
        )

        resultado = response.choices[0].message.content
        await ctx.reply(resultado)

    except Exception as e:
        print("Error al procesar imagen:", e)
        await ctx.reply("‚ùåHubo un error al analizar la imagen.‚ùå")
        #En caso de que ocurra un erro se notifica al chat

@bot.command(name="historial")
async def historial(ctx, cantidad: int = 5):
    registros = get_user_history(ctx.author.id, cantidad)
    if not registros:
        await ctx.reply("No tienes historial guardado todav√≠a.")
        return

    mensaje = "√öltimos mensajes con la IA:\n\n"
    for i, (prompt, response, timestamp) in enumerate(registros, start=1):
        mensaje += f"{i}.** {timestamp[:19]}\n"
        mensaje += f"üë§T√∫: {prompt}\n ü§ñIA: {response[:150]}...\n\n"
    await ctx.reply(mensaje)


bot.run(token_d) #Esto iniciara el bot de Discord